<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>List of Students</title>


    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">

    

    <!--Favicon & CSS Path-->
    <link rel="icon" type="image/x-icon" href="/src/CSS/img/temp.png">
    <link rel="stylesheet" type="text/css" href="/src/CSS/main.css">
</head>
<body id="identifier">
    
      <!--Navigation animation bar--->
	<div id="mySidenav" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
        <a href="#Welcome"><p id="para"><span class="glyphicon glyphicon-user"></span></p></a>
        <a href="index.html">Enter Marks</a>
        <a href="preview.html">Preview</a>
        <a href="ListToPrint.html">List</a>
        <a href="#" id="link"><span class="glyphicon glyphicon-log-out"></span>Logout</a>
      </div>
      <span style="font-size:30px;cursor:pointer" onclick="openNav()">&#9776;Menu</span>
    
    
      
    
        <div id="HTMLtoPDF">
            <h1 id="topic"><img src="/src/CSS/img/focused logo.png" width="40px"> Riverside Adventist Academy</h1>
            <p id="listed"><b>Elementary & Secondary Mid-Term Assessment Records for 2023</b></p>
         </div>
         <div class="container justify-content-center">
            <form class="form-inline">
                Class     
                <select id="Sclass" class="mb-2 mr-sm-2" name="class">
                    <option value="one">I</option>
                    <option value="two">II</option>
                    <option value="three">III</option>
                    <option value="four">IV</option>
                    <option value="five">V</option>
                    <option value="six">VI</option>
                    <option value="seven">VII</option>
                    <option value="eight">VIII</option>
                    <option value="nine">IX</option>
                    <option value="ten">X</option>
                    <option value="eleven">XI</option>
                    <option value="twelve">XII</option>
                </select>
                Section
                <select id="Ssection" class="mb-2 mr-sm-2" name="section">
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                        <option value="D">D</option>
                </select>
                Term
                <select id="STerm" class="mb-2 mr-sm-2" name="Term">
                    <option value="MidTerm">MidTerm</option>
                    <option value="EndTerm">EndTerm</option>
                </select>
                <button type="button" class="btn btn-primary"id="Get">Get</button>
    
            </form>
         </div> 







         <div class="container">
            <div class="col-sm-11 table-responsive-sm">
                <table class="table table-hover table-sm table-bordered text-center" id="myTable">
                    <thead class="thead-dark">
                        <tr>
                            <th>Rollno</th>
                            <th>Name</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody id="tbody1">
    
                    </tbody>
        
             </div>  
             </table>


             <script>
        
                function openNav() {
                        document.getElementById("mySidenav").style.width = "250px";
                    }
                    function closeNav() {
                        document.getElementById("mySidenav").style.width = "0";
                    }  
             </script>   


<script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.19.1/firebase-analytics.js";
    import{doc,collection,getDocs,getDoc,getFirestore,query,orderBy} from "https://www.gstatic.com/firebasejs/9.19.1/firebase-firestore.js";
    import { getAuth,signOut,onAuthStateChanged} from "https://www.gstatic.com/firebasejs/9.19.1/firebase-auth.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
        apiKey: "",
        authDomain: "",
        databaseURL: "",
        projectId: "",
        storageBucket: "",
        messagingSenderId: "",
        appId: "",
        measurementId: ""
    };
    // Initialize Firebase
    const app = initializeApp(firebaseConfig);

     //init services
    const db=getFirestore(app);
    const auth = getAuth();

    document.getElementById("link").addEventListener("click",flogout);
    document.getElementById("identifier").addEventListener("load",onAuthStateChanged);
    document.getElementById("Get").addEventListener("click",Fetch);

    onAuthStateChanged(auth, (user) => {
        if (user) {
          // User is signed in, see docs for a list of available properties
          // https://firebase.google.com/docs/reference/js/firebase.User
          const uid = user.uid;
          console.log("User that is logged in is",uid);
          console.log(user.email);
          document.getElementById("para").innerHTML="Welcome"+" "+user.email;
          // ...
        } else {
          // User is signed out
          // ...
          //console.log("Sorry you have not logged in");
          document.getElementById("Get").disabled = true;
          window.location.href = "Login.html";
        }
      });

      function flogout(){
        auth.signOut().then(()=>{
          console.log("User is SignOut");
          window.location.href = "Login.html";
      });
      }





    function ClearThePopulatedTable(){
         var table = document.getElementById("myTable");
                    var rowCount = table.rows.length;
                    console.log("The rowCount is :",rowCount);
                    while(rowCount>1){
                        table.deleteRow(--rowCount);
                        rowCount = table.rows.length;
                        console.log("The rowCount is :",rowCount);

                    }

    }



    function Fetch(){
        
                    ClearThePopulatedTable();
                    var c = document.getElementById("Sclass").value;
                    console.log("Class_"+c);
                    var section = document.getElementById("Ssection").value;
                    console.log("Section_"+section);
                    var term = document.getElementById("STerm").value;
                    console.log(term);
                    
                    //Testing to fetch the collection Data
                    (async () => {
                    try {
                        // Query the first page of docs
                    const colRef = query(collection(db, "Class_"+c,"Section_"+section,term),orderBy("RollNo"));
                    
                    const docSnap = await getDocs(colRef);
                    

                    
                    let count=1;
                    docSnap.forEach(doc => {
                        console.log(doc.data());
                        Filling_Table(doc.id,doc.data(),count);
                        count++;
                    });   
                    } catch (error) {
                    console.log(error);
                    }
                    })();
            }


            function Filling_Table(R,stu,n){
                        const rowIdx=n;
                        let roll=stu.RollNo;
                        let name=stu.Name;

                        var c = document.getElementById("Sclass").value;
                        console.log("Class_"+c);
                        var section = document.getElementById("Ssection").value;
                        console.log("Section_"+section);
                        var term = document.getElementById("STerm").value;
                        console.log(term);
                


    
                        const Subject_marks = [roll,name];
                      
                        var table = document.getElementById("myTable");
                        var row = table.insertRow(rowIdx);
                        var count=0;
                        var cell1;
                        for(let i=0;i<Subject_marks.length;i++){
                                cell1 = row.insertCell(i);
                                cell1.innerHTML = Subject_marks[count];
                                count++;
                        }

                        // Creating Edit Button
                        cell1=row.insertCell(count);
                        let Printbtn = document.createElement("button");
                        Printbtn.innerHTML = "Print";
                        Printbtn.type = "submit";
                        Printbtn.id="PrintBtn";
                        Printbtn.name = "PrintBtn";
                        Printbtn.addEventListener("click", function() {
                                
                            localStorage.clear();
                             //Testing to fetch the collection Data
                            (async () => {
                            try {
                                // Query the first page of docs
                            const docRef = doc(db, "Class_"+c,"Section_"+section,"EndTerm",R);
                            
                            const docSnap = await getDoc(docRef);
                            
                        
                            if (docSnap.exists()) {
                                
                                console.log("Document data:", docSnap.data());
                                const myObject2 = { EndTerm:  docSnap.data(),
                                                    MidTerm: stu,
                                                    Class: c};
                                const myObjectString2 = JSON.stringify(myObject2);
                                localStorage.setItem('StudentDetails', myObjectString2);
                                
                                
                                } else {
                                // docSnap.data() will be undefined in this case
                                console.log("No such document!");
                                }
                            } catch (error) {
                            console.log(error);
                            }
                            })();
                            function delay(){
                                window.open("Result.html");

                            }
                            
                            if (localStorage.getItem("StudentDetails") == null) {
                                setTimeout(delay,500);
                            
                            }
                            
                        });
                        cell1.appendChild(Printbtn);
                        
            }
           
    </script>
</body>
</html>
